<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeTap Secure Chat</title>
    <!-- Load required CDNs for styling and functionality -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        /* Apply the Inter font globally for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Light grey background for the area outside the phone container */
            background-color: #1f2937; 
        }
        #root {
            /* Makes the app container fill the screen on small devices */
            width: 100%;
            height: 100vh; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Desktop/Tablet view: Constrain the size to look like a phone */
        @media (min-width: 1024px) {
            #root > div {
                height: 90vh;
                border-radius: 1.5rem; /* Rounded corners for the phone bezel effect */
            }
        }
    </style>

    <!-- 
      1. Firebase CDN Scripts 
      We define the firebase object and expose the necessary functions 
      to the global scope so the React component can access them.
    -->
    <script>
        window.firebase = {};
    </script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script>window.firebase.app = firebase.app;</script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script>window.firebase.auth = { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };</script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script>window.firebase.firestore = { getFirestore, setLogLevel, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp };</script>

</head>
<body>
    <div id="root"></div>

    <!-- 
      2. REACT COMPONENT SCRIPT 
      The entire App.jsx content is moved here. Using type="text/babel" allows 
      the Babel CDN to process the JSX and React code directly in the HTML.
    -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        const ReactDOM = window.ReactDOM;

        // --- Global Context Variables (Fixed to satisfy the Linter) ---
        // We reference 'window' to safely access global variables expected from the environment.
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        // NOTE: Firebase SDK functions (initializeApp, getAuth, getFirestore, etc.) 
        // are accessed via window.firebase.module, as defined in the head.

        // --- Utility Functions ---

        /** @returns {string} The shortened user ID for display. */
        const getShortUserId = (uid) => uid ? uid.substring(0, 8) + '...' : 'anonymous';

        /** @returns {string} Formats Firestore timestamp to a readable time string. */
        const formatTime = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return '...'; 
            const date = timestamp.toDate();
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        };


        // --- Component for a single message bubble ---
        const MessageBubble = ({ message, currentUserId }) => {
            const isSender = message.senderId === currentUserId;
            const isSystem = message.senderId === 'system';

            if (isSystem) {
                return (
                    <div className="flex w-full justify-center text-center my-4 font-inter">
                        <div className="px-4 py-2 max-w-sm bg-cyan-600 text-white shadow-xl rounded-xl mx-auto">
                            <p className="text-sm font-bold text-center">{message.content}</p>
                        </div>
                    </div>
                );
            }

            const bubbleClasses = isSender
                ? 'bg-[#00B8D9] text-white shadow-lg rounded-tl-xl rounded-tr-xl rounded-bl-xl ml-auto rounded-br-sm'
                : 'bg-[#1E4077] text-white shadow-lg rounded-tl-xl rounded-tr-xl rounded-br-xl mr-auto rounded-bl-sm';
            
            const rowClasses = isSender ? 'justify-end' : 'justify-start';
            const headerText = isSender ? 'You' : `User (${getShortUserId(message.senderId)})`;
            const initials = message.senderId ? message.senderId.charAt(0).toUpperCase() : '?';

            return (
                <div className={`flex w-full mb-4 ${rowClasses} font-inter`}>
                    {/* Avatar for Receiver (Left Side) */}
                    {!isSender && (
                        <div className="flex-shrink-0 w-8 h-8 rounded-full bg-[#12284D] text-white flex items-center justify-center text-sm font-bold mr-2 self-start border border-gray-600">
                            {initials}
                        </div>
                    )}
                    
                    <div className="flex flex-col max-w-[80%] md:max-w-[60%]">
                        {/* Header (Sender Name and Time) */}
                        <div className={`text-xs mb-1 px-1 ${isSender ? 'text-right' : 'text-left'}`}>
                            <span className="font-semibold text-gray-200 mr-2">{headerText}</span>
                            <span className="text-gray-400">{formatTime(message.timestamp)}</span>
                        </div>
                        
                        {/* Message Bubble Content */}
                        <div className={`px-4 py-3 break-words whitespace-pre-wrap ${bubbleClasses}`}>
                            <div className="text-sm">
                                {message.content}
                            </div>
                        </div>
                    </div>

                    {/* Avatar for Sender (Right Side) */}
                    {isSender && (
                        <div className="flex-shrink-0 w-8 h-8 rounded-full bg-[#12284D] text-white flex items-center justify-center text-sm font-bold ml-2 self-start border border-gray-600">
                            {initials}
                        </div>
                    )}
                </div>
            );
        };


        // --- Main App Component ---
        const App = () => {
            // State
            const [messages, setMessages] = useState([]);
            const [messageInput, setMessageInput] = useState('');
            const [currentUserId, setCurrentUserId] = useState(null);
            const [authReady, setAuthReady] = useState(false);
            const [dbInstance, setDbInstance] = useState(null);
            const [isSending, setIsSending] = useState(false);

            // Refs
            const chatAreaRef = useRef(null);
            const textAreaRef = useRef(null);

            // Custom dark colors (using utility classes directly)
            const COLOR_DARK_NAVY_BLACK = 'bg-[#0A2041]'; // Header, Footer, Input Container BG
            const COLOR_MAIN_BLUE = 'bg-[#12284D]';       // Main Chat BG

            // --- Firebase Initialization and Authentication ---
            useEffect(() => {
                // Essential check for global firebase object
                if (typeof window.firebase === 'undefined' || typeof window.firebase.app === 'undefined') {
                    console.error("Firebase is not initialized in the global window object.");
                    setAuthReady(false);
                    setCurrentUserId('firebase-missing');
                    return;
                }

                try {
                    // Access functions globally, relying on CDN setup (window.firebase.module)
                    const { initializeApp } = window.firebase.app;
                    const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.firebase.auth;
                    const { getFirestore, setLogLevel } = window.firebase.firestore;

                    // 1. Initialize Firebase
                    const app = initializeApp(firebaseConfig);
                    const db = getFirestore(app);
                    const auth = getAuth(app);
                    setLogLevel('debug');
                    
                    setDbInstance(db);

                    // 2. Handle Authentication
                    const authenticate = async () => {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Auth initialization failed:", e);
                            // Fallback to anonymous sign-in is crucial if custom token fails
                            await signInAnonymously(auth); 
                        }
                    };

                    // 3. Set up Auth State Listener
                    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                        // If user exists, use their UID; otherwise, generate a temporary one
                        const uid = user ? user.uid : (currentUserId || (typeof crypto !== 'undefined' ? crypto.randomUUID() : 'temp-id-' + Math.random().toString(36).substring(7)));
                        setCurrentUserId(uid);
                        setAuthReady(true);
                    });

                    authenticate();

                    return () => unsubscribeAuth();
                } catch (e) {
                    console.error("Firebase setup failed (Global scope error):", e);
                    setAuthReady(false);
                    setCurrentUserId('error-user');
                }
            }, [currentUserId]); 

            // --- Data Fetching (Snapshot Listener) ---
            useEffect(() => {
                if (!dbInstance || !authReady) return;

                // Access Firestore functions globally
                const { collection, query, orderBy, onSnapshot } = window.firebase.firestore;
                
                const chatCollectionPath = `artifacts/${appId}/public/data/messages`;
                
                // Firestore query setup
                const q = query(collection(dbInstance, chatCollectionPath), orderBy('timestamp'));

                const unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                    let allMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Add a guaranteed System Message if the chat is empty or system message is missing
                    if (allMessages.length === 0 || allMessages.length > 0 && allMessages[0].senderId !== 'system') {
                        const systemMessage = {
                            id: 'system-init',
                            content: 'SafeTap Initialized. You are now connected to the secure chat channel.',
                            senderId: 'system',
                            timestamp: { toDate: () => new Date() }
                        };
                        // Prepend system message for a cleaner start
                        allMessages = [systemMessage, ...allMessages]; 
                    }
                    
                    setMessages(allMessages);
                    
                    // Scroll to bottom after new messages load
                    setTimeout(() => {
                        if (chatAreaRef.current) {
                            chatAreaRef.current.scrollTop = chatAreaRef.current.scrollHeight;
                        }
                    }, 50);
                }, (error) => {
                    console.error("Firestore snapshot error:", error);
                    setMessages([{ id: 'error', content: `Error loading chat: ${error.message}`, senderId: 'system', timestamp: { toDate: () => new Date() } }]);
                });

                return () => unsubscribeSnapshot();
            }, [dbInstance, authReady, appId]);


            // --- Send Message Handler ---
            const handleSend = useCallback(async () => {
                const content = messageInput.trim();
                if (content === '' || !dbInstance || !currentUserId || isSending || !authReady) return;

                setIsSending(true);
                const { collection, addDoc, serverTimestamp } = window.firebase.firestore;

                const chatCollectionPath = `artifacts/${appId}/public/data/messages`;
                
                const messageData = {
                    content: content,
                    senderId: currentUserId,
                    timestamp: serverTimestamp(), 
                };

                try {
                    await addDoc(collection(dbInstance, chatCollectionPath), messageData);
                    setMessageInput(''); // Clear input
                } catch (e) {
                    console.error("Error adding document: ", e);
                } finally {
                    setIsSending(false);
                }
            }, [messageInput, dbInstance, currentUserId, isSending, authReady, appId]);
            
            // --- Input Management ---
            const handleKeyDown = (e) => {
                // Handle Shift + Enter for new line, Enter alone for sending
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            };
            
            // Autofocus and autoresize
            useEffect(() => {
                if (textAreaRef.current) {
                    textAreaRef.current.style.height = 'auto'; // Reset height
                    textAreaRef.current.style.height = `${textAreaRef.current.scrollHeight}px`; // Set new height
                }
            }, [messageInput]);


            const isAppFunctional = authReady && currentUserId && dbInstance;
            const canSend = isAppFunctional && messageInput.trim() !== '' && !isSending;

            return (
                // Outer Container (Simulates Phone Bezel/Wrapper)
                <div className="flex flex-col h-screen w-screen max-w-md lg:h-[90vh] lg:rounded-3xl shadow-2xl overflow-hidden font-inter">
                    
                    {/* App Content Area */}
                    <div className={`flex flex-col h-full w-full ${COLOR_MAIN_BLUE}`}>
                        
                        {/* Header: Fixed at the top */}
                        <header className={`flex-shrink-0 p-4 pt-8 ${COLOR_DARK_NAVY_BLACK} shadow-xl flex flex-col items-center justify-center`}>
                            <div className="flex flex-col items-center space-y-1">
                                {/* Phone Icon (SVG) */}
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-white"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-5.6-5.6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 3.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                <h1 className="text-xl font-bold tracking-wider text-white">SafeTap</h1>
                            </div>
                            <p className="text-xs text-gray-400 font-medium uppercase mt-0.5">
                                ONE TAP TO SAFETY
                            </p>
                        </header>

                        {/* Chat Area Header */}
                        <div className={`flex-shrink-0 px-4 pt-4 pb-2 ${COLOR_MAIN_BLUE} border-b border-[#1E4077]`}>
                            <h2 className="text-lg font-semibold text-gray-100">Chat Area</h2>
                            <p className="text-xs text-gray-400">
                                User ID: {isAppFunctional ? getShortUserId(currentUserId) : (authReady ? 'Authenticating...' : 'Connecting...')}
                            </p>
                        </div>

                        {/* Main Chat Area: Scrollable content */}
                        <main ref={chatAreaRef} className={`flex-grow px-4 pt-2 overflow-y-auto ${COLOR_MAIN_BLUE} space-y-4 flex flex-col`}>
                            {messages.length === 0 && (
                                <p className="text-center text-gray-400 mt-10">
                                    {authReady ? 'Loading messages...' : 'Establishing connection...'}
                                </p>
                            )}
                            {messages.map((msg) => (
                                <MessageBubble key={msg.id} message={msg} currentUserId={currentUserId} />
                            ))}
                        </main>

                        {/* Input Container: Fixed above the bottom nav */}
                        <div className={`flex-shrink-0 p-4 ${COLOR_DARK_NAVY_BLACK} shadow-2xl`}>
                            <div className="flex items-end bg-[#1E4077] rounded-full p-1 shadow-inner">
                                <textarea
                                    ref={textAreaRef}
                                    value={messageInput}
                                    onChange={(e) => setMessageInput(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                    className="flex-grow bg-transparent text-white placeholder-gray-400 resize-none outline-none overflow-hidden max-h-40 py-3 px-4 text-base disabled:opacity-50"
                                    placeholder={isAppFunctional ? "Type a message..." : "Connecting to chat..."}
                                    rows={1}
                                    disabled={!isAppFunctional || isSending}
                                />
                                <button 
                                    onClick={handleSend}
                                    className={`w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 transform ${
                                        canSend 
                                        ? 'bg-[#00B8D9] text-white shadow-lg shadow-cyan-900/50 hover:scale-105'
                                        : 'bg-gray-600 text-gray-300 cursor-not-allowed opacity-60'
                                    } disabled:cursor-not-allowed`} 
                                    disabled={!canSend}
                                >
                                    {/* Send Icon (SVG) */}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4 20-7z"/><path d="M11 11 22 2"/></svg>
                                </button>
                            </div>
                        </div>

                        {/* Bottom Navigation: Fixed at the very bottom */}
                        <nav className={`flex-shrink-0 p-2 ${COLOR_DARK_NAVY_BLACK} shadow-inner`}>
                            <div className="flex justify-around items-center">
                                {/* Nav Items */}
                                {/* Home Icon (Active) */}
                                <div className="nav-item flex flex-col items-center justify-center p-1.5 cursor-pointer text-xs transition-colors duration-200 text-white font-semibold">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                    <span className="mt-0.5 whitespace-nowrap">Home</span>
                                </div>
                                {/* Live Location Icon */}
                                <div className="nav-item flex flex-col items-center justify-center p-1.5 cursor-pointer text-xs transition-colors duration-200 text-gray-400 hover:text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <span className="mt-0.5 whitespace-nowrap">Live Locat...</span>
                                </div>
                                {/* Panic Icon */}
                                <div className="nav-item flex flex-col items-center justify-center p-1.5 cursor-pointer text-xs transition-colors duration-200 text-gray-400 hover:text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                                    <span className="mt-0.5 whitespace-nowrap">Panic</span>
                                </div>
                                {/* Fake Screen Icon */}
                                <div className="nav-item flex flex-col items-center justify-center p-1.5 cursor-pointer text-xs transition-colors duration-200 text-gray-400 hover:text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
                                    <span className="mt-0.5 whitespace-nowrap">Fake Screen</span>
                                </div>
                                {/* SOS Icon */}
                                <div className="nav-item flex flex-col items-center justify-center p-1.5 cursor-pointer text-xs transition-colors duration-200 text-gray-400 hover:text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.67 17.67l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M17.67 6.33l1.41-1.41"/></svg>
                                    <span className="mt-0.5 whitespace-nowrap">SOS</span>
                                </div>
                                {/* Recording Icon */}
                                <div className="nav-item flex flex-col items-center justify-center p-1.5 cursor-pointer text-xs transition-colors duration-200 text-gray-400 hover:text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 16h4"/><path d="M10 8h4"/><path d="M12 2v4"/><path d="M12 18v4"/></svg>
                                    <span className="mt-0.5 whitespace-nowrap">Recording</span>
                                </div>
                            </div>
                        </nav>
                    </div>
                </div>
            );
        };

        // 3. Render the application 
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(App));
        } catch(e) {
            console.error("Failed to render React application:", e);
            document.getElementById('root').innerHTML = '<div style="color: red; padding: 20px;">App failed to load. Check console for errors.</div>';
        }
    </script>
</body>
</html>

